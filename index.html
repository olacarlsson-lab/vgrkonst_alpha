<!DOCTYPE html>
<html lang="sv" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VGR Konst SÃ¶k</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <meta name="theme-color" content="#020617" />
  
  <style>
    :root{
      --brand:#38bdf8;
      --brand-dark:#0ea5e9;
    }

    /* DARK THEME */
    :root[data-theme="dark"]{
      --body-bg: radial-gradient(circle at top, #0f172a 0, #020617 38%, #020617 100%);
      --header-bg: linear-gradient(to bottom, rgba(15,23,42,0.9), rgba(15,23,42,0.4), transparent 80%);
      --text-main:#e5e7eb;
      --text-muted:#9ca3af;

      --panel-bg:rgba(15,23,42,0.95);
      --card-bg:rgba(15,23,42,0.95);
      --chip-bg:#0f172a;

      --border-soft:#1f2937;
      --border-strong:#1e293b;

      --field-bg:#020617;

      --btn-primary-fg:#0b1020;
      --btn-secondary-bg:#020617;
      --btn-secondary-border:#1f2937;
      --btn-secondary-fg:#9ca3af;

      --selection-add-bg:#022c22;
      --selection-add-fg:#bbf7d0;
      --selection-add-border:#064e3b;
    }

    /* LIGHT THEME */
    :root[data-theme="light"]{
      --body-bg: radial-gradient(circle at top, #e0f2fe 0, #f7f9fc 40%, #eff3f8 100%);
      --header-bg: linear-gradient(to bottom, rgba(255,255,255,0.96), rgba(243,244,246,0.9), transparent 80%);
      --text-main:#111827;
      --text-muted:#6b7280;

      --panel-bg:#ffffff;
      --card-bg:#ffffff;
      --chip-bg:#e5e7eb;

      --border-soft:#d1d5db;
      --border-strong:#cbd5f5;

      --field-bg:#f9fafb;

      --btn-primary-fg:#f9fafb;
      --btn-secondary-bg:#f9fafb;
      --btn-secondary-border:#d1d5db;
      --btn-secondary-fg:#374151;

      --selection-add-bg:#ecfdf3;
      --selection-add-fg:#166534;
      --selection-add-border:#bbf7d0;
    }

    *{box-sizing:border-box}

    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      margin:0;
      background:var(--body-bg);
      color:var(--text-main);
      min-height:100vh;
    }

    header{
      padding:18px 16px 10px;
      background:var(--header-bg);
      backdrop-filter:blur(16px);
    }

    .header-inner{
      max-width:1000px;
      margin:0 auto;
      padding:0 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .title-block h1{
      margin:0;
      font-size:1.6rem;
      font-weight:500;
      letter-spacing:.04em;
      color:var(--text-main);
    }

    .title-block h1 span{
      font-weight:600;
      color:var(--brand);
    }

    .title-block p{
      margin:6px 0 0;
      font-size:.9rem;
      color:var(--text-muted);
    }

    #themeToggle{
      border:none;
      border-radius:999px;
      padding:.45rem .8rem;
      cursor:pointer;
      font-size:1rem;
      background:var(--btn-secondary-bg);
      color:var(--btn-secondary-fg);
      border:1px solid var(--btn-secondary-border);
      box-shadow:0 4px 14px rgba(15,23,42,.35);
    }
    #themeToggle:hover{
      filter:brightness(1.05);
    }

    .wrap{
      max-width:1000px;
      margin:0 auto;
      padding:0 12px 28px;
    }

    /* SÃ¶kfÃ¤lt */
    #searchForm{
      display:grid;
      grid-template-columns:repeat(4,minmax(170px,1fr));
      gap:10px 12px;
      background:var(--panel-bg);
      padding:14px 14px 12px;
      border-radius:16px;
      border:1px solid var(--border-strong);
      box-shadow:
        0 18px 45px rgba(15,23,42,.35),
        0 0 0 1px rgba(148,163,184,.06);
    }

    #searchForm input[type="search"],
    #searchForm select{
      padding:.7rem .85rem;
      border:1px solid var(--border-soft);
      border-radius:10px;
      font-size:.95rem;
      background:var(--field-bg);
      color:var(--text-main);
      transition:border-color .18s,box-shadow .18s,background .18s;
    }

    #searchForm input[type="search"]::placeholder{
      color:var(--text-muted);
    }

    #searchForm input[type="search"]:focus,
    #searchForm select:focus{
      outline:none;
      border-color:var(--brand);
      box-shadow:0 0 0 1px rgba(56,189,248,.9);
    }

    #searchForm select{
      appearance:none;
      background-image:
        linear-gradient(45deg,transparent 50%, #9ca3af 50%),
        linear-gradient(135deg,#9ca3af 50%,transparent 50%);
      background-position:
        calc(100% - 16px) 45%,
        calc(100% - 12px) 45%;
      background-size:5px 5px;
      background-repeat:no-repeat;
      padding-right:26px;
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:stretch;
    }

    button{
      border:none;
      border-radius:999px;
      padding:.8rem 1.1rem;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 10px 25px rgba(15,23,42,.3);
      font-size:.9rem;
    }

    #searchBtn{
      background:linear-gradient(135deg,var(--brand),var(--brand-dark));
      color:var(--btn-primary-fg);
      border:none;
    }
    #searchBtn:hover{
      filter:brightness(1.06);
      box-shadow:0 14px 32px rgba(56,189,248,.6);
    }

    #clearBtn{
      background:var(--btn-secondary-bg);
      color:var(--btn-secondary-fg);
      border-radius:999px;
      border:1px solid var(--btn-secondary-border);
      box-shadow:none;
    }
    #clearBtn:hover{
      filter:brightness(1.03);
    }

    /* Totaler */
    #totalCount{
      margin-top:12px;
      font-size:.9rem;
      color:var(--text-muted);
    }

    /* Kortlayout */
    .cards{
      margin-top:14px;
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:12px;
    }

    .card{
      background:var(--card-bg);
      border-radius:14px;
      padding:14px 14px;
      border:1px solid var(--border-strong);
      box-shadow:
        0 14px 35px rgba(15,23,42,.25),
        0 0 0 1px rgba(148,163,184,.04);
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .kv{
      display:grid;
      grid-template-columns:105px 1fr;
      gap:6px 10px;
      align-items:start;
    }
    .k{
      color:var(--text-muted);
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.06em;
    }
    .v{
      font-weight:500;
      color:var(--text-main);
      font-size:.9rem;
    }

    .empty{
      margin-top:18px;
      color:var(--text-muted);
      text-align:center;
      font-size:.95rem;
    }

    /* Klickbara fÃ¤lt-lÃ¤nkar */
    .v a.field-link{
      color:var(--brand);
      text-decoration:none;
      cursor:pointer;
      margin-right:4px;
    }
    .v a.field-link:hover{
      text-decoration:underline;
    }

    /* + / âˆ’ bredvid lÃ¤nkarna */
    .filter-ops{
      display:inline-flex;
      gap:4px;
      align-items:center;
    }
    .filter-btn{
      border:none;
      background:transparent;
      padding:0 4px;
      cursor:pointer;
      font-weight:700;
      font-size:.85em;
      line-height:1;
      color:var(--text-muted);
    }
    .filter-btn:hover{
      color:var(--text-main);
    }

    /* Urval/knapp-styles */
    .card.selected{
      outline:1px solid rgba(56,189,248,.7);
      box-shadow:
        0 18px 45px rgba(15,23,42,.4),
        0 0 0 1px rgba(56,189,248,.4);
    }

    .card .add-btn{
      align-self:flex-start;
      padding:6px 11px;
      border-radius:999px;
      cursor:pointer;
      font-weight:600;
      background:var(--btn-secondary-bg);
      color:var(--btn-secondary-fg);
      box-shadow:none;
      border:1px solid var(--btn-secondary-border);
      font-size:.8rem;
    }
    .card .add-btn:hover{
      filter:brightness(1.05);
    }
    .card.selected .add-btn{
      background:rgba(56,189,248,.12);
      color:var(--brand-dark);
      border-color:rgba(56,189,248,.7);
    }

    .note-line{
      font-size:.8rem;
      color:var(--text-main);
      background:var(--panel-bg);
      padding:6px 8px;
      border-radius:8px;
      border:1px solid var(--border-soft);
    }

    /* Expanderbar urvalslista */
    .sel-list{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      max-height:180px;
      overflow:auto;
      padding:6px;
      background:var(--panel-bg);
      border-radius:10px;
      box-shadow:0 10px 28px rgba(15,23,42,.25);
      border:1px solid var(--border-soft);
    }

    .sel-item{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      background:var(--chip-bg);
      font-weight:500;
      font-size:.8rem;
      color:var(--text-main);
      border:1px solid var(--border-soft);
    }

    .sel-item button{
      border:none;
      background:transparent;
      cursor:pointer;
      font-weight:700;
      line-height:1;
      font-size:.9rem;
      color:var(--text-muted);
    }
    .sel-item button:hover{
      color:var(--text-main);
    }

    #selectionBar{
      margin-top:10px;
    }

    /* Mindre knappar i urvalspanelen */
    #selectionBar button{
      padding:4px 12px;
      font-size:0.8rem;
      border-radius:999px;
      box-shadow:none;
      border:1px solid var(--border-soft);
    }

    #selectionCount{
      font-size:.85rem;
      color:var(--text-muted);
    }

    #addAllBtn{
      background:var(--selection-add-bg);
      color:var(--selection-add-fg);
      border-color:var(--selection-add-border);
    }
    #addAllBtn:hover{
      filter:brightness(1.05);
    }

    #copyMailSelBtn{
      background:linear-gradient(135deg,var(--brand),var(--brand-dark));
      color:var(--btn-primary-fg);
      border:none;
    }

    #clearSelBtn{
      background:var(--btn-secondary-bg);
      color:var(--btn-secondary-fg);
    }
    #clearSelBtn:hover{
      filter:brightness(1.05);
    }

    details#selectionDetails summary{
      color:var(--text-muted);
      font-size:.85rem;
    }

    /* Mobilanpassning */
    @media (max-width: 900px){
      #searchForm{grid-template-columns:repeat(2,1fr)}
      .cards{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width: 560px){
      .title-block h1{font-size:1.3rem}
      #searchForm{grid-template-columns:1fr}
      .actions{flex-direction:column}
      #searchBtn,#clearBtn{width:100%}
      .cards{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="title-block">
        <h1><span>VGR</span> Ã¶ppna konstdata</h1>
        <p>SÃ¶k, filtrera och bygg urval av konstverk</p>
      </div>
      <button id="themeToggle" type="button" aria-label="Byt tema">ðŸŒ™</button>
    </div>
  </header>

  <div class="wrap">
    <!-- FormulÃ¤r -->
    <form id="searchForm" aria-label="SÃ¶k i datasetet">
      <input type="search" id="creatorInput" placeholder="konstnÃ¤r" autocomplete="off" />
      <input type="search" id="titleInput" placeholder="titel" autocomplete="off" />
      <input type="search" id="createdInput" placeholder="framstÃ¤llningsÃ¥r" autocomplete="off" />
      <select id="artformSelect"><option value="">konsttyp (alla)</option></select>
      <select id="artmediumSelect"><option value="">teknik (alla)</option></select>
      <input type="search" id="idInput" placeholder="vg-nummer" autocomplete="off" />
      <input type="search" id="olderIdInput" placeholder="Ã¤ldre id" autocomplete="off" />
      <div class="actions">
        <button id="searchBtn" type="submit">SÃ¶k</button>
        <button id="clearBtn" type="button">Rensa</button>
      </div>
    </form>

    <!-- Totaler + urvalspanel -->
    <div id="totalCount"></div>
    <div id="selectionBar" style="display:flex; gap:8px; align-items:center;">
      <span id="selectionCount">Urval: 0</span>
      <button id="addAllBtn" type="button">LÃ¤gg till alla</button>
      <button id="copyMailSelBtn" type="button">Kopiera/Maila urval</button>
      <button id="clearSelBtn" type="button">Rensa urval</button>
    </div>

    <!-- Expanderbar urvalslista -->
    <details id="selectionDetails" style="margin-top:6px;">
      <summary style="cursor:pointer; user-select:none;">Visa urval</summary>
      <div id="selectionList" class="sel-list" aria-live="polite"></div>
    </details>

    <div id="cards" class="cards" role="list"></div>
    <div id="empty" class="empty" hidden>Inga resultat.</div>
  </div>

  <script>
    // ======= Tema-toggle (light/dark) =======
    const THEME_KEY = 'vgr_konst_theme';

    function applyTheme(theme){
      const root = document.documentElement;
      root.setAttribute('data-theme', theme);
      const btn = document.getElementById('themeToggle');
      if(btn){
        const isDark = theme === 'dark';
        btn.textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
        btn.title = isDark ? 'Byt till ljust tema' : 'Byt till mÃ¶rkt tema';
      }
    }

    (function initTheme(){
      try{
        const stored = localStorage.getItem(THEME_KEY);
        let theme;
        if(stored === 'light' || stored === 'dark'){
          theme = stored;
        }else if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
          theme = 'dark';
        }else{
          theme = 'light';
        }
        applyTheme(theme);
      }catch{
        applyTheme('dark');
      }
    })();

    document.getElementById('themeToggle').addEventListener('click', () => {
      const current = document.documentElement.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
      const next = current === 'dark' ? 'light' : 'dark';
      applyTheme(next);
      try{ localStorage.setItem(THEME_KEY, next); }catch{}
    });

    // ======= Konfiguration =======
    const datasetBaseURL = 'https://vgregion.entryscape.net/rowstore/dataset/1802e57a-b25d-4716-8437-9ed648bbae59';
    const BOM_OLDER_ID_KEY = '\uFEFFolder id';

    const columnsOrder = ["creator","title","created","artform","artmedium","id",BOM_OLDER_ID_KEY];
    const columnsMap = {
      "creator":"KonstnÃ¤r","title":"Titel","created":"FramstÃ¤llningsÃ¥r",
      "artform":"Konsttyp","artmedium":"Teknik","id":"VG-nummer",[BOM_OLDER_ID_KEY]:"Ã„ldre id"
    };

    const inputIdMap = {
      "creator":"creatorInput","title":"titleInput","created":"createdInput",
      "artform":"artformSelect","artmedium":"artmediumSelect","id":"idInput",[BOM_OLDER_ID_KEY]:"olderIdInput"
    };

    let allData = [];

    // ======= Dropdown-listor =======
    const ART_FORMS = [
      "Blandteknik","Collage","Emalj","Fotografi","Grafik","Installation","Ljud","MÃ¥leri","Objekt",
      "Relief","RÃ¶rlig bild","Skulptur","Teckning","Textil","Ã–vrigt"
    ];

    const ART_MEDIA_RAW = [
      "Ã–vrigt","Ã–vrigt","VÃ¤vteknik","VÃ¤ggmÃ¥lning","Ull","Tusch/BlÃ¤ck","Tusch","TrÃ¤snitt","TrÃ¤relief","TrÃ¤","Tryck",
      "TorrnÃ¥l","Textil","Textil","TemporÃ¤r","Tempera","Teckning","Svartvit","Stengods/flintgods/keramik","Sten","Skulptur",
      "Silkscreen/Serigrafi","Silkscreen","Serigrafi","RÃ¶rlig bild","Relief","porslin","Pochoir","Plast","Pastell","Pastell",
      "Olja","Objekt","MÃ¥leri","Monotypi","Mixed media","Mezzotint","Metall","Metall","Ljud","Litografi","Linoleum","Krita",
      "Kopparstick","Konsthantverk/TrÃ¤","Konsthantverk/Sten","Konsthantverk/Metall","Konsthantverk/Keramik","Konsthantverk/Glas",
      "Kol","Keramikrelief","Gravyr","Grafik","Graffiti","Gouache","Glas","Gipsrelief","Gips","FÃ¤rg","Fotopolymer/Fotogravyr",
      "Fotografi","Etsning","Emalj","Emalj","Digitalt pigmenttryck","Digitalprint/GiclÃ©e","Collografi/Intaglio","Collografi",
      "Collage","collage","Byggnadsintegrerad","Brons","Broderi","Blyerts","Blandteknik","Blandteknik","Blandteknik",
      "Blandteknik","Blandteknik","Blandteknik","Betong","Batik","Applikation","Akvatint","Akvarell","Akryl"
    ];

    function uniqueSorted(list){
      const cleaned = list
        .map(s => (s || '').toString().trim())
        .filter(Boolean)
        .map(s => s === 'collage' ? 'Collage' : s.replace(/\s+/g,' '));
      const uniq = [...new Set(cleaned)];
      return uniq.sort((a,b) => a.localeCompare(b,'sv'));
    }
    const ART_MEDIA = uniqueSorted(ART_MEDIA_RAW);

    function populateSelect(el, options, labelAll){
      el.innerHTML = `<option value="">${labelAll}</option>`;
      options.forEach(v=>{
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        el.appendChild(opt);
      });
    }

    // ======= HjÃ¤lpfunktioner =======
    const removeAccents = (str) => str.normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase();
    const capitalizeWords = (str) => str.replace(/(^|\s)\S/g, c => c.toLocaleUpperCase('sv-SE'));
    const normalizeText = (str) => str.normalize("NFC").trim();
    function normalizeOlderIdInput(input){
      input = normalizeText(input);
      if(!input) return '';
      if(/^\d+\s*[a-zA-Z]$/.test(input)){ return input.replace(/\s*([a-zA-Z])$/,(_,L)=>' '+L.toUpperCase()); }
      const m = input.match(/^(\d+)([a-zA-Z])$/);
      return m ? m[1] + ' ' + m[2].toUpperCase() : input;
    }
    function cleanDataKeys(dataArray){
      return dataArray.map(item=>{
        const n={}; for(const k in item){ n[k.replace(/^\uFEFF/,'')] = item[k]; } return n;
      });
    }

    function clearAllFilters(){
      for (const mapKey in inputIdMap) {
        const el = document.getElementById(inputIdMap[mapKey]);
        if (!el) continue;
        if (el.tagName === 'SELECT') el.value = '';
        else el.value = '';
      }
    }

    // ======= URL â†’ parametrar =======
    function paramsFromURL() {
      const p = new URLSearchParams(location.search);
      const accepted = ["creator","title","created","artform","artmedium","id","older id"];
      const params = {};
      accepted.forEach(k => { if (p.has(k)) params[k] = p.get(k); });
      return params;
    }

    // ****** LIMIT 100 ******
    function buildQuery(params){
      const parts=[];
      for(const key in params){
        if(params[key]){
          let actualKey = key, val = params[key];
          if(key==='older id'||key===BOM_OLDER_ID_KEY){ actualKey=BOM_OLDER_ID_KEY; val=normalizeOlderIdInput(val); }
          if(key==='id'){ val = val.toUpperCase(); }
          parts.push(encodeURIComponent(actualKey)+'='+encodeURIComponent(val));
        }
      }
      return parts.length ? '?'+parts.join('&')+'&_limit=100&_offset=0' : '?_limit=100&_offset=0';
    }

    // ======= HÃ¤mtning + lokalt accent-insensitivt filter =======
    async function fetchData(params={}, rawSearch={}){
      const url = datasetBaseURL + buildQuery(params);
      try{
        const res = await fetch(url, {headers:{accept:'application/json'}});
        if(!res.ok) throw new Error(`HTTP-fel: ${res.status}`);
        const json = await res.json();
        allData = cleanDataKeys(json.results || []);

        const filterKeys = Object.keys(rawSearch);
        if(filterKeys.length){
          allData = allData.filter(row=>{
            return filterKeys.every(key=>{
              const sv = removeAccents(String(rawSearch[key] ?? ''));
              const rv = removeAccents(String(row[key] ?? ''));
              return rv.includes(sv);
            });
          });
        }
        renderCards(allData);
      }catch(err){
        document.getElementById('cards').innerHTML='';
        document.getElementById('empty').hidden=false;
        document.getElementById('totalCount').textContent = 'Kunde inte hÃ¤mta data.';
        console.error(err);
        alert('HÃ¤mtfel: '+err.message);
      }
    }

    // ======= Urval (med anteckning + datasnapshot) =======
    const SEL_KEY = 'vgr_konst_selection';
    const SEL_LIMIT = 300;

    let selection = (()=>{
      try{
        const raw = localStorage.getItem(SEL_KEY);
        const parsed = raw ? JSON.parse(raw) : null;
        if(Array.isArray(parsed)){
          const obj = {};
          parsed.forEach(id=>{ obj[String(id).toUpperCase()] = { note:'', data:null }; });
          localStorage.setItem(SEL_KEY, JSON.stringify(obj));
          return obj;
        }
        return parsed && typeof parsed==='object' ? parsed : {};
      }catch{ return {}; }
    })();

    function saveSelection(){ localStorage.setItem(SEL_KEY, JSON.stringify(selection)); }
    function selectionSize(){ return Object.keys(selection).length; }
    function hasSelection(id){ return !!selection[String(id||'').toUpperCase()]; }
    function isVG(s) { return /^VG\d+$/i.test(String(s || '')); }

    function promptAndNormalizeNote(def = ''){
      const n = prompt('Anteckning (valfritt):', def ?? '');
      return n === null ? null : String(n).trim();
    }

    function addToSelection(entry, note='') {
      const id = String(entry?.id || entry || '').toUpperCase();
      if (!isVG(id)) return;
      if (!hasSelection(id) && selectionSize() >= SEL_LIMIT) {
        alert(`Max ${SEL_LIMIT} i urvalet.`);
        return;
      }
      const olderKey = 'older id';
      const data = entry && typeof entry === 'object' ? {
        creator: entry.creator ?? '',
        title: entry.title ?? '',
        created: entry.created ?? '',
        artform: entry.artform ?? '',
        artmedium: entry.artmedium ?? '',
        [olderKey]: entry[olderKey] ?? entry[BOM_OLDER_ID_KEY] ?? ''
      } : (selection[id]?.data || null);
      selection[id] = { note: note || (selection[id]?.note || ''), data };
      saveSelection();
      updateSelectionUI();
    }

    function removeFromSelection(id) {
      id = String(id || '').toUpperCase();
      if (selection[id]) delete selection[id];
      saveSelection();
      updateSelectionUI();
    }

    function toggleSelection(entry){
      const id = String(entry?.id || entry || '').toUpperCase();
      if (hasSelection(id)) {
        removeFromSelection(id);
      } else {
        const note = promptAndNormalizeNote('');
        if (note === null) return;
        addToSelection(entry, note);
      }
    }

    function updateSelectionUI() {
      const el = document.getElementById('selectionCount');
      if (el) el.textContent = `Urval: ${selectionSize()}`;

      document.querySelectorAll('.card[data-vg]').forEach(card => {
        const id = card.getAttribute('data-vg') || '';
        const btn = card.querySelector('.add-btn');
        if (!btn) return;
        const selected = hasSelection(id);
        const noteTxt = (selection[id]?.note || '').trim();
        btn.textContent = selected ? 'Ta bort frÃ¥n urval' : 'LÃ¤gg till i urval';
        btn.setAttribute('aria-pressed', String(selected));
        btn.title = selected && noteTxt ? `Anteckning: ${noteTxt}` : (isVG(id) ? `LÃ¤gg till/ta bort ${id} frÃ¥n urval` : 'Denna rad saknar giltigt VG-nummer');
        card.classList.toggle('selected', selected);

        let nl = card.querySelector('.note-line');
        if (selected && noteTxt) {
          if (!nl) {
            nl = document.createElement('div');
            nl.className = 'note-line';
            card.appendChild(nl);
          }
          nl.textContent = `Anteckning: ${noteTxt}`;
        } else if (nl) {
          nl.remove();
        }
      });

      const list = document.getElementById('selectionList');
      if (list) {
        const ids = Object.keys(selection).sort((a,b)=>a.localeCompare(b,'sv',{numeric:true}));
        list.innerHTML = ids.map(id => {
          const item = selection[id] || {};
          const raw = (item.note || '').trim();
          const has = raw.length > 0;
          const preview = has ? ` â€” ${raw.split('\n')[0].slice(0, 60)}` : '';
          const titleAttr = has
            ? ` title="${raw.replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"`

            : '';
          return `<span class="sel-item" data-id="${id}"${titleAttr}>
            ${id}${has ? ' ðŸ“Œ' : ''}<span style="font-weight:400;opacity:.85;">${preview}</span>
            <button type="button" data-edit="${id}" title="Redigera anteckning">âœŽ</button>
            <button type="button" data-remove="${id}" title="Ta bort ${id}">Ã—</button>
          </span>`;
        }).join('');

        const details = document.getElementById('selectionDetails');
        const summary = details?.querySelector('summary');
        if (summary) summary.textContent = selectionSize() ? `Visa urval (${selectionSize()})` : 'Visa urval';
      }
    }

    document.getElementById('selectionList')?.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;

      if (btn.dataset.remove) {
        removeFromSelection(btn.dataset.remove);
        return;
      }

      if (btn.dataset.edit) {
        const id = btn.dataset.edit;
        const current = (selection[id]?.note || '').trim();
        const note = promptAndNormalizeNote(current);
        if (note !== null) {
          selection[id] = selection[id] || { note:'', data:null };
          selection[id].note = note;
          saveSelection();
          updateSelectionUI();
        }
      }
    });

    // ======= Export: BYGG TEXT, KOPIERA, MAILA =======
    function buildSelectionText() {
      const ids = Object.keys(selection).sort((a,b)=>a.localeCompare(b,'sv',{numeric:true}));
      if (ids.length === 0) return null;

      const blocks = ids.map(id => {
        const item = selection[id] || {}; const d = item.data || {};
        return [
          `KonstnÃ¤r: ${d.creator || ''}`,
          `Titel: ${d.title || ''}`,
          `FramstÃ¤llningsÃ¥r: ${d.created || ''}`,
          `Konsttyp: ${d.artform || ''}`,
          `Teknik: ${d.artmedium || ''}`,
          `VG-nummer: ${id}`,
          `Ã„ldre id: ${d['older id'] || ''}`,
          `Anteckning: ${item.note || ''}`
        ].join('\n');
      });
      const quoted = ids.map(id => `"${id}"`).join(', ');
      return blocks.join('\n\n') + `\n\n${quoted}`;
    }

    async function copySelectionToClipboard() {
      const text = buildSelectionText();
      if (!text) { alert('Urvalet Ã¤r tomt.'); return false; }
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (e) {
        console.warn('Clipboard API misslyckades:', e);
        window.prompt('Kopiera manuellt:', text);
        return false;
      }
    }

    function openEmailComposeWith(text) {
      const defaultSubject = `Urval â€“ VGR konst (${new Date().toLocaleDateString('sv-SE')})`;
      const subject = prompt('Ã„mne fÃ¶r e-posten:', defaultSubject);
      if (subject === null) return;

      const encSubject = encodeURIComponent(subject.trim());
      const encBody = encodeURIComponent(text);

      const outlookUrl = `ms-outlook://compose?subject=${encSubject}&body=${encBody}`;
      const mailtoUrl  = `mailto:?subject=${encSubject}&body=${encBody}`;

      let opened = false;
      const timer = setTimeout(() => {
        if (!opened) window.location.href = mailtoUrl;
      }, 700);

      try {
        window.location.href = outlookUrl;
        opened = true;
      } catch (e) {
        clearTimeout(timer);
        window.location.href = mailtoUrl;
      }
    }

    async function copyThenMaybeEmail() {
      const text = buildSelectionText();
      if (!text) { alert('Urvalet Ã¤r tomt.'); return; }

      const copied = await copySelectionToClipboard();
      const goMail = confirm(copied
        ? 'Urvalet Ã¤r kopierat. Vill du Ã¶ppna e-post med urvalet inklistrat?'
        : 'Vill du Ã¶ppna e-post med urvalet Ã¤ndÃ¥?');
      if (goMail) openEmailComposeWith(text);
      else if (copied) alert('Klart! Urvalet finns i urklipp.');
    }

    // ======= LÃ¤gg till alla frÃ¥n aktuell sÃ¶kning =======
    function addAllFromCurrentSearch() {
      if (!allData || allData.length === 0) {
        alert('Inga resultat att lÃ¤gga till.');
        return;
      }
      let addedCount = 0;
      for (const row of allData) {
        const vg = (row['id'] || '').toString().toUpperCase();
        if (!isVG(vg)) continue;
        if (hasSelection(vg)) continue;
        if (selectionSize() >= SEL_LIMIT) break;
        addToSelection({ ...row, id: vg }, '');
        addedCount++;
      }
      if (addedCount === 0) {
        alert('Inga nya VG-nummer lades till (antingen redan i urvalet eller urvalet Ã¤r fullt).');
      } else {
        alert(`La till ${addedCount} VG-nummer frÃ¥n sÃ¶kningen i urvalet.`);
      }
    }

    // ======= Kort-rendering + totaler =======
    function renderCards(data){
      const wrap = document.getElementById('cards');
      const empty = document.getElementById('empty');
      const total = document.getElementById('totalCount');

      wrap.innerHTML='';
      total.textContent='';

      if(!data.length){
        empty.hidden=false;
        total.textContent = 'Inga resultat.';
        updateSelectionUI();
        return;
      }

      empty.hidden=true;
      total.textContent = data.length >= 100 ? 'Totalt â‰¥100 resultat (visar max 100)' : `Totalt ${data.length} resultat`;

      const frag = document.createDocumentFragment();
      data.forEach(row=>{
        const card = document.createElement('div');
        card.className='card';

        const vg = (row['id'] || '').toString().toUpperCase();
        if (isVG(vg)) card.setAttribute('data-vg', vg);

        const kv = document.createElement('div');
        kv.className='kv';

        columnsOrder.forEach(col=>{
          const key = col.replace(/^\uFEFF/,'');
          let val = row[key] ?? '';
          if (key === 'id' && typeof val === 'string') val = val.toUpperCase();

          const k = document.createElement('div');
          k.className='k';
          k.textContent = columnsMap[col];

          const v = document.createElement('div');
          v.className='v';

          // GÃ¶r vissa fÃ¤lt klickbara: creator, created, artform, artmedium
          if (['creator','created','artform','artmedium'].includes(key) && val) {
            const ops = document.createElement('span');
            ops.className = 'filter-ops';

            const link = document.createElement('a');
            link.href = '#';
            link.textContent = val;
            link.className = 'field-link';

            // Klick pÃ¥ sjÃ¤lva lÃ¤nken: nollstÃ¤ll andra filter och sÃ¶k bara pÃ¥ detta vÃ¤rde
            link.addEventListener('click', (e) => {
              e.preventDefault();

              const targetKey = key;
              const targetVal = val.toString();

              clearAllFilters();

              const fieldId = inputIdMap[targetKey];
              const fieldEl = document.getElementById(fieldId);
              if (fieldEl) {
                if (fieldEl.tagName === 'SELECT') {
                  fieldEl.value = targetVal;
                } else {
                  fieldEl.value = targetVal;
                }
              }

              runSearchFromForm();
            });

            ops.appendChild(link);

            // BestÃ¤m om filtret redan Ã¤r aktivt fÃ¶r detta fÃ¤lt
            const fieldId = inputIdMap[key];
            const fieldEl = document.getElementById(fieldId);
            let currentVal = '';
            if (fieldEl) {
              currentVal = fieldEl.tagName === 'SELECT' ? fieldEl.value : fieldEl.value;
            }

            const isActive = normalizeText(String(currentVal)) === normalizeText(String(val));

            if (!isActive) {
              // + : lÃ¤gg till detta filter utan att ta bort andra
              const plusBtn = document.createElement('button');
              plusBtn.type = 'button';
              plusBtn.textContent = '+';
              plusBtn.className = 'filter-btn';
              plusBtn.title = 'LÃ¤gg till som filter';

              plusBtn.addEventListener('click', (e) => {
                e.preventDefault();

                const targetKey = key;
                const targetVal = val.toString();
                const fieldId = inputIdMap[targetKey];
                const fieldEl = document.getElementById(fieldId);
                if (fieldEl) {
                  if (fieldEl.tagName === 'SELECT') {
                    fieldEl.value = targetVal;
                  } else {
                    fieldEl.value = targetVal;
                  }
                }

                runSearchFromForm();
              });

              ops.appendChild(plusBtn);
            } else {
              // âˆ’ : ta bort just detta filter (tÃ¶m fÃ¤ltet) och sÃ¶k om
              const minusBtn = document.createElement('button');
              minusBtn.type = 'button';
              minusBtn.textContent = 'âˆ’';
              minusBtn.className = 'filter-btn';
              minusBtn.title = 'Ta bort detta filter';

              minusBtn.addEventListener('click', (e) => {
                e.preventDefault();

                const targetKey = key;
                const fieldId = inputIdMap[targetKey];
                const fieldEl = document.getElementById(fieldId);
                if (fieldEl) {
                  if (fieldEl.tagName === 'SELECT') {
                    fieldEl.value = '';
                  } else {
                    fieldEl.value = '';
                  }
                }

                runSearchFromForm();
              });

              ops.appendChild(minusBtn);
            }

            v.appendChild(ops);
          } else {
            v.textContent = val;
          }

          kv.appendChild(k);
          kv.appendChild(v);
        });

        const btn = document.createElement('button');
        btn.className = 'add-btn';
        btn.type = 'button';
        const existingNote = (selection[vg]?.note || '').trim();
        btn.title = isVG(vg)
          ? (existingNote ? `Anteckning: ${existingNote}` : `LÃ¤gg till/ta bort ${vg} frÃ¥n urval`)
          : 'Denna rad saknar giltigt VG-nummer';
        const selected = hasSelection(vg);
        btn.textContent = selected ? 'Ta bort frÃ¥n urval' : 'LÃ¤gg till i urval';
        btn.setAttribute('aria-pressed', String(selected));
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (!isVG(vg)) {
            alert('Denna rad saknar giltigt VG-nummer.');
            return;
          }
          toggleSelection({ ...row, id: vg });
        });

        card.appendChild(kv);
        card.appendChild(btn);

        if (selected) card.classList.add('selected');

        frag.appendChild(card);
      });

      wrap.appendChild(frag);
      updateSelectionUI();
    }

    // ======= FormulÃ¤r-sÃ¶kning, Ã¥teranvÃ¤nds av bÃ¥de submit + klickbara lÃ¤nkar =======
    function runSearchFromForm() {
      const params = {}, raw = {};
      for(const key in columnsMap){
        const cleanKey = key.replace(/^\uFEFF/,'');
        const el = document.getElementById(inputIdMap[key]);
        if(el){
          let val = normalizeText(el.value);
          if(val){
            if(cleanKey==='creator') val = capitalizeWords(val);
            if(cleanKey==='older id') val = normalizeOlderIdInput(val);
            params[cleanKey] = val;
            raw[cleanKey] = val;
          }
        }
      }
      fetchData(params, raw);
    }

    // ======= HÃ¤ndelser =======
    document.getElementById('searchForm').addEventListener('submit', e=>{
      e.preventDefault();
      runSearchFromForm();
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      clearAllFilters();
      fetchData({}, {}); // ladda om med standard
    });

    // Knappar i urvalspanelen
    document.getElementById('addAllBtn')?.addEventListener('click', addAllFromCurrentSearch);
    document.getElementById('copyMailSelBtn')?.addEventListener('click', copyThenMaybeEmail);
    document.getElementById('clearSelBtn')?.addEventListener('click', ()=>{
      if (selectionSize() === 0) return;
      if (!confirm('Rensa hela urvalet?')) return;
      selection = {};
      saveSelection();
      updateSelectionUI();
      document.getElementById('selectionDetails')?.removeAttribute('open');
    });

    // ======= Init: dropdowns + auto-sÃ¶k frÃ¥n URL =======
    populateSelect(document.getElementById('artformSelect'), ART_FORMS, 'konsttyp (alla)');
    populateSelect(document.getElementById('artmediumSelect'), ART_MEDIA, 'teknik (alla)');

    (()=>{
      const urlParams = paramsFromURL();
      for (const key in urlParams) {
        const el = document.getElementById(inputIdMap[key] || "");
        if (el) el.value = urlParams[key];
      }
      if (Object.keys(urlParams).length) {
        fetchData(urlParams, urlParams).then(updateSelectionUI);
      } else {
        fetchData({}, {}).then(updateSelectionUI);
      }
    })();

    // PWA
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js')
        .then(r=>console.log('âœ… Service worker:', r.scope))
        .catch(err=>console.error('SW-fel:', err));
    }
  </script>
</body>
</html>
